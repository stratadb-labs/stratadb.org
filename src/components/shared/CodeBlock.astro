---
interface Props {
  code: string;
  lang?: string;
  filename?: string;
  showLineNumbers?: boolean;
  highlight?: number[];
}

const {
  code,
  lang = 'text',
  filename,
  showLineNumbers = false,
  highlight = []
} = Astro.props;

const lines = code.trim().split('\n');
---

<div class="code-block relative group rounded-xl overflow-hidden border border-border">
  {/* Header */}
  {filename && (
    <div class="flex items-center justify-between px-4 py-2 bg-background-muted border-b border-border">
      <span class="text-sm text-text-muted font-mono">{filename}</span>
      <span class="text-xs text-text-muted uppercase">{lang}</span>
    </div>
  )}

  {/* Code */}
  <div class="relative">
    <pre class="overflow-x-auto p-4 text-sm bg-background-muted"><code class:list={[`language-${lang}`, 'font-mono']}>{lines.map((line, i) => (
      <span
        class:list={[
          'block',
          highlight.includes(i + 1) && 'bg-terracotta/10 -mx-4 px-4'
        ]}
      >
        {showLineNumbers && (
          <span class="inline-block w-8 text-text-muted select-none">{i + 1}</span>
        )}
        {line || ' '}
      </span>
    ))}</code></pre>

    {/* Copy button */}
    <button
      class="copy-button absolute top-2 right-2 p-2 rounded-lg bg-background border border-border text-text-muted hover:text-text-primary opacity-0 group-hover:opacity-100 transition-opacity"
      data-code={code}
      aria-label="Copy code"
    >
      <svg class="w-4 h-4 copy-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
      </svg>
      <svg class="w-4 h-4 check-icon hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
      </svg>
    </button>
  </div>
</div>

<script>
  document.querySelectorAll('.copy-button').forEach((button) => {
    button.addEventListener('click', async () => {
      const code = button.getAttribute('data-code');
      if (code) {
        await navigator.clipboard.writeText(code);

        const copyIcon = button.querySelector('.copy-icon');
        const checkIcon = button.querySelector('.check-icon');

        copyIcon?.classList.add('hidden');
        checkIcon?.classList.remove('hidden');

        setTimeout(() => {
          copyIcon?.classList.remove('hidden');
          checkIcon?.classList.add('hidden');
        }, 2000);
      }
    });
  });
</script>
